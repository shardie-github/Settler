"use strict";exports.id=221,exports.ids=[221],exports.modules={11045:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.config=void 0;var a=r(27184);Object.defineProperty(t,"config",{enumerable:!0,get:function(){return a.validatedConfig}})},27184:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.validatedConfig=void 0;let a=r(93665),i=void 0===process.env.NEXT_PHASE&&"true"!==process.env.NEXT_BUILD&&process.env.VERCEL?(0,a.cleanEnv)(process.env,{NODE_ENV:(0,a.str)({choices:["development","test","production","staging","preview"],default:"development"}),PORT:(0,a.port)({default:3e3}),HOST:(0,a.host)({default:"0.0.0.0"}),DB_HOST:(0,a.host)({default:"localhost"}),DB_PORT:(0,a.port)({default:5432}),DB_NAME:(0,a.str)({default:"settler"}),DB_USER:(0,a.str)({default:"postgres"}),DB_PASSWORD:(0,a.str)({default:"postgres",devDefault:"postgres"}),DB_SSL:(0,a.bool)({default:!1}),DB_POOL_MIN:(0,a.num)({default:5}),DB_POOL_MAX:(0,a.num)({default:20}),DB_CONNECTION_TIMEOUT:(0,a.num)({default:2e3}),DB_STATEMENT_TIMEOUT:(0,a.num)({default:3e4}),REDIS_HOST:(0,a.host)({default:"localhost"}),REDIS_PORT:(0,a.port)({default:6379}),REDIS_URL:(0,a.url)({default:void 0}),REDIS_PASSWORD:(0,a.str)({default:void 0}),REDIS_TLS:(0,a.bool)({default:!1}),JWT_SECRET:(0,a.str)({default:"dev-secret-change-in-production",devDefault:"dev-secret-change-in-production",desc:"Secret key for JWT token signing"}),JWT_ACCESS_EXPIRY:(0,a.str)({default:"15m"}),JWT_REFRESH_EXPIRY:(0,a.str)({default:"7d"}),JWT_REFRESH_SECRET:(0,a.str)({default:void 0,devDefault:void 0,desc:"Optional separate secret for refresh tokens"}),ENCRYPTION_KEY:(0,a.str)({default:"dev-encryption-key-32-chars-long!!",devDefault:"dev-encryption-key-32-chars-long!!",desc:"32-byte key for AES-256-GCM encryption"}),RATE_LIMIT_DEFAULT:(0,a.num)({default:1e3}),RATE_LIMIT_WINDOW_MS:(0,a.num)({default:9e5}),WEBHOOK_MAX_RETRIES:(0,a.num)({default:5}),WEBHOOK_INITIAL_DELAY:(0,a.num)({default:2e3}),WEBHOOK_MAX_DELAY:(0,a.num)({default:32e3}),DATA_RETENTION_DAYS:(0,a.num)({default:365}),ALLOWED_ORIGINS:(0,a.str)({default:"*",desc:"Comma-separated list of allowed origins"}),LOG_LEVEL:(0,a.str)({choices:["error","warn","info","debug"],default:"info"}),LOG_SAMPLING_RATE:(0,a.num)({default:1}),SERVICE_NAME:(0,a.str)({default:"settler-api"}),OTLP_ENDPOINT:(0,a.url)({default:void 0}),JAEGER_ENDPOINT:(0,a.url)({default:void 0}),SENTRY_DSN:(0,a.url)({default:void 0}),SENTRY_ENVIRONMENT:(0,a.str)({default:void 0}),SENTRY_TRACES_SAMPLE_RATE:(0,a.num)({default:.1}),ENABLE_SCHEMA_PER_TENANT:(0,a.bool)({default:!1}),ENABLE_REQUEST_TIMEOUT:(0,a.bool)({default:!0}),ENABLE_API_DOCS:(0,a.bool)({default:!0}),DEPLOYMENT_ENV:(0,a.str)({choices:["local","staging","production"],default:"local"}),TRUST_PROXY:(0,a.bool)({default:!1}),SECURE_COOKIES:(0,a.bool)({default:!1}),METRICS_ENABLED:(0,a.bool)({default:!0}),HEALTH_CHECK_ENABLED:(0,a.bool)({default:!0})}):{NODE_ENV:"production",PORT:Number(process.env.PORT||3e3),HOST:process.env.HOST||"0.0.0.0",DB_HOST:process.env.DB_HOST||"localhost",DB_PORT:Number(process.env.DB_PORT||5432),DB_NAME:process.env.DB_NAME||"settler",DB_USER:process.env.DB_USER||"postgres",DB_PASSWORD:process.env.DB_PASSWORD||"postgres",DB_SSL:"true"===process.env.DB_SSL,DB_POOL_MIN:Number(process.env.DB_POOL_MIN||5),DB_POOL_MAX:Number(process.env.DB_POOL_MAX||20),DB_CONNECTION_TIMEOUT:Number(process.env.DB_CONNECTION_TIMEOUT||2e3),DB_STATEMENT_TIMEOUT:Number(process.env.DB_STATEMENT_TIMEOUT||3e4),REDIS_HOST:process.env.REDIS_HOST||"localhost",REDIS_PORT:Number(process.env.REDIS_PORT||6379),REDIS_URL:process.env.REDIS_URL,REDIS_PASSWORD:process.env.REDIS_PASSWORD,REDIS_TLS:"true"===process.env.REDIS_TLS,JWT_SECRET:process.env.JWT_SECRET||"dev-secret-change-in-production",JWT_ACCESS_EXPIRY:process.env.JWT_ACCESS_EXPIRY||"15m",JWT_REFRESH_EXPIRY:process.env.JWT_REFRESH_EXPIRY||"7d",JWT_REFRESH_SECRET:process.env.JWT_REFRESH_SECRET,ENCRYPTION_KEY:process.env.ENCRYPTION_KEY||"dev-encryption-key-32-chars-long!!",RATE_LIMIT_DEFAULT:Number(process.env.RATE_LIMIT_DEFAULT||1e3),RATE_LIMIT_WINDOW_MS:Number(process.env.RATE_LIMIT_WINDOW_MS||9e5),WEBHOOK_MAX_RETRIES:Number(process.env.WEBHOOK_MAX_RETRIES||5),WEBHOOK_INITIAL_DELAY:Number(process.env.WEBHOOK_INITIAL_DELAY||2e3),WEBHOOK_MAX_DELAY:Number(process.env.WEBHOOK_MAX_DELAY||32e3),DATA_RETENTION_DAYS:Number(process.env.DATA_RETENTION_DAYS||365),ALLOWED_ORIGINS:process.env.ALLOWED_ORIGINS||"*",LOG_LEVEL:process.env.LOG_LEVEL||"info",LOG_SAMPLING_RATE:Number(process.env.LOG_SAMPLING_RATE||1),SERVICE_NAME:process.env.SERVICE_NAME||"settler-api",OTLP_ENDPOINT:process.env.OTLP_ENDPOINT,JAEGER_ENDPOINT:process.env.JAEGER_ENDPOINT,SENTRY_DSN:process.env.SENTRY_DSN,SENTRY_ENVIRONMENT:process.env.SENTRY_ENVIRONMENT,SENTRY_TRACES_SAMPLE_RATE:Number(process.env.SENTRY_TRACES_SAMPLE_RATE||.1),ENABLE_SCHEMA_PER_TENANT:"true"===process.env.ENABLE_SCHEMA_PER_TENANT,ENABLE_REQUEST_TIMEOUT:"false"!==process.env.ENABLE_REQUEST_TIMEOUT,ENABLE_API_DOCS:"false"!==process.env.ENABLE_API_DOCS,DEPLOYMENT_ENV:process.env.DEPLOYMENT_ENV||"local",TRUST_PROXY:"true"===process.env.TRUST_PROXY,SECURE_COOKIES:"true"===process.env.SECURE_COOKIES,METRICS_ENABLED:"false"!==process.env.METRICS_ENABLED,HEALTH_CHECK_ENABLED:"false"!==process.env.HEALTH_CHECK_ENABLED};if(!(void 0!==process.env.NEXT_PHASE||"true"===process.env.NEXT_BUILD||void 0!==process.env.__NEXT_PRIVATE_STANDALONE_BUILD)&&("production"===i.NODE_ENV||"preview"===i.NODE_ENV)){if(!i.ENCRYPTION_KEY||32!==i.ENCRYPTION_KEY.length)throw Error(`ENCRYPTION_KEY must be exactly 32 characters in ${i.NODE_ENV}`);if(!i.JWT_SECRET||"dev-secret-change-in-production"===i.JWT_SECRET)throw Error(`JWT_SECRET must be set to a secure random value in ${i.NODE_ENV}`);"*"===i.ALLOWED_ORIGINS&&console.warn(`WARNING: CORS allows all origins in ${i.NODE_ENV}. Consider restricting ALLOWED_ORIGINS.`)}t.validatedConfig={nodeEnv:i.NODE_ENV,port:i.PORT,host:i.HOST,database:{host:i.DB_HOST,port:i.DB_PORT,name:i.DB_NAME,user:i.DB_USER,password:i.DB_PASSWORD,ssl:i.DB_SSL,poolMin:i.DB_POOL_MIN,poolMax:i.DB_POOL_MAX,connectionTimeout:i.DB_CONNECTION_TIMEOUT,statementTimeout:i.DB_STATEMENT_TIMEOUT},redis:{host:i.REDIS_HOST,port:i.REDIS_PORT,url:i.REDIS_URL,password:i.REDIS_PASSWORD,tls:i.REDIS_TLS},jwt:{secret:i.JWT_SECRET,accessTokenExpiry:i.JWT_ACCESS_EXPIRY,refreshTokenExpiry:i.JWT_REFRESH_EXPIRY,refreshSecret:i.JWT_REFRESH_SECRET||i.JWT_SECRET},encryption:{key:i.ENCRYPTION_KEY},rateLimiting:{defaultLimit:i.RATE_LIMIT_DEFAULT,windowMs:i.RATE_LIMIT_WINDOW_MS},webhook:{maxRetries:i.WEBHOOK_MAX_RETRIES,initialDelay:i.WEBHOOK_INITIAL_DELAY,maxDelay:i.WEBHOOK_MAX_DELAY},dataRetention:{defaultDays:i.DATA_RETENTION_DAYS},allowedOrigins:i.ALLOWED_ORIGINS.split(",").map(e=>e.trim()),logging:{level:i.LOG_LEVEL,samplingRate:i.LOG_SAMPLING_RATE},observability:{serviceName:i.SERVICE_NAME,otlpEndpoint:i.OTLP_ENDPOINT,jaegerEndpoint:i.JAEGER_ENDPOINT},sentry:{dsn:i.SENTRY_DSN,environment:i.SENTRY_ENVIRONMENT||i.NODE_ENV,tracesSampleRate:i.SENTRY_TRACES_SAMPLE_RATE},features:{enableSchemaPerTenant:i.ENABLE_SCHEMA_PER_TENANT,enableRequestTimeout:i.ENABLE_REQUEST_TIMEOUT,enableApiDocs:i.ENABLE_API_DOCS},deployment:{env:i.DEPLOYMENT_ENV},security:{trustProxy:i.TRUST_PROXY,secureCookies:i.SECURE_COOKIES},monitoring:{metricsEnabled:i.METRICS_ENABLED,healthCheckEnabled:i.HEALTH_CHECK_ENABLED}}},70058:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.sendTrialWelcomeEmail=l,t.sendTrialValueEmail=s,t.sendTrialGatedFeaturesEmail=u,t.sendTrialCaseStudyEmail=c,t.sendTrialComparisonEmail=d,t.sendTrialUrgencyEmail=_,t.sendTrialEndedEmail=p,t.sendPaidWelcomeEmail=m,t.sendMonthlySummaryEmail=E,t.sendLowActivityEmail=f;let a=r(67894),i=r(5383),o=r(43863);function n(e){let t=(0,i.getDefaultUrls)(),r={...e},a={};t?.product_name!==void 0&&(a.product_name=t.product_name),t?.upgrade_url!==void 0&&(a.upgrade_url=t.upgrade_url),t?.dashboard_url!==void 0&&(a.dashboard_url=t.dashboard_url),t?.support_url!==void 0&&(a.support_url=t.support_url),t?.pricing_url!==void 0&&(a.pricing_url=t.pricing_url),t?.docs_url!==void 0&&(a.docs_url=t.docs_url),t?.playground_url!==void 0&&(a.playground_url=t.playground_url),t?.cookbooks_url!==void 0&&(a.cookbooks_url=t.cookbooks_url);let o={};return t?.profile_setup_url!==void 0&&(o.profile_setup_url=t.profile_setup_url),t?.demo_url!==void 0&&(o.demo_url=t.demo_url),t?.free_tier_url!==void 0&&(o.free_tier_url=t.free_tier_url),t?.free_tier_info_url!==void 0&&(o.free_tier_info_url=t.free_tier_info_url),t?.consultation_url!==void 0&&(o.consultation_url=t.consultation_url),t?.insights_url!==void 0&&(o.insights_url=t.insights_url),r.product=a,r.urls=o,r}async function l(e,t){try{let r=e.firstName||e.email.split("@")[0]||"User",o=new Date(t.trialEndDate),l=isNaN(o.getTime())?void 0:new Date(o.getTime()+2592e6).toISOString().split("T")[0],s={trial_end_date:t.trialEndDate,trial_start_date:t.trialStartDate,days_remaining:t.daysRemaining};l&&(s.charge_date=l);let u=n({user:{first_name:r,email:e.email,...e.industry&&{industry:e.industry},...e.companyName&&{company_name:e.companyName},plan_type:e.planType||"trial"},trial:s}),c=await (0,i.renderEmailTemplate)("trial_welcome",u),d=(0,i.generatePlainText)(c);return(0,a.sendEmail)({to:e.email,subject:"Welcome to Settler! \uD83C\uDF89",html:c,text:d,tags:[{name:"email_type",value:"trial_welcome"}]})}catch(t){return(0,o.logError)("Failed to send trial welcome email",t,{user:e.email}),null}}async function s(e,t,r){try{let o=e.firstName||e.email.split("@")[0]||"User",l=n({user:{first_name:o,email:e.email},trial:{days_remaining:t.daysRemaining},reconciliation:{platform_name:r.platformName,matched_count:r.matchedCount,unmatched_count:r.unmatchedCount,time_saved:r.timeSaved,report_url:r.reportUrl}}),s=await (0,i.renderEmailTemplate)("trial_day2",l),u=(0,i.generatePlainText)(s);return(0,a.sendEmail)({to:e.email,subject:"Your first reconciliation is ready! \uD83C\uDF89",html:s,text:u,tags:[{name:"email_type",value:"trial_value"}]})}catch(t){return(0,o.logError)("Failed to send trial value email",t,{user:e.email}),null}}async function u(e,t){try{let r={user:{first_name:e.firstName||e.email.split("@")[0]||"User",email:e.email},trial:{days_remaining:t.daysRemaining}},o=await (0,i.renderEmailTemplate)("trial_day7",r),n=(0,i.generatePlainText)(o);return(0,a.sendEmail)({to:e.email,subject:"Unlock advanced features (still free for 23 days)",html:o,text:n,tags:[{name:"email_type",value:"trial_gated_features"}]})}catch(t){return(0,o.logError)("Failed to send trial gated features email",t,{user:e.email}),null}}async function c(e,t,r){try{let o=(0,i.getDefaultUrls)(),n={user:{first_name:e.firstName||e.email.split("@")[0]||"User",email:e.email,...e.industry&&{industry:e.industry}},trial:{days_remaining:t.daysRemaining},case_study:{similar_company:r.companyName,case_study_url:r.caseStudyUrl,case_studies_url:`${o?.docs_url||"https://docs.settler.dev"}/case-studies`}},l=await (0,i.renderEmailTemplate)("trial_day14",n),s=(0,i.generatePlainText)(l);return(0,a.sendEmail)({to:e.email,subject:`How ${r.companyName} saved 15 hours/week with Settler`,html:l,text:s,tags:[{name:"email_type",value:"trial_case_study"}]})}catch(t){return(0,o.logError)("Failed to send trial case study email",t,{user:e.email}),null}}async function d(e,t){try{let r={user:{first_name:e.firstName||e.email.split("@")[0]||"User",email:e.email},trial:{days_remaining:t.daysRemaining}},o=await (0,i.renderEmailTemplate)("trial_day21",r),n=(0,i.generatePlainText)(o);return(0,a.sendEmail)({to:e.email,subject:"Here's what you're missing (9 days left)",html:o,text:n,tags:[{name:"email_type",value:"trial_comparison"}]})}catch(t){return(0,o.logError)("Failed to send trial comparison email",t,{user:e.email}),null}}async function _(e,t,r){try{let o={user:{first_name:e.firstName||e.email.split("@")[0]||"User",email:e.email},trial:(()=>{let e=new Date(t.trialEndDate),r=isNaN(e.getTime())?void 0:new Date(e.getTime()+2592e6).toISOString().split("T")[0],a={trial_end_date:t.trialEndDate,days_remaining:t.daysRemaining};return r&&(a.charge_date=r),a})()},n=`trial_day${r}`,l=await (0,i.renderEmailTemplate)(n,o),s=(0,i.generatePlainText)(l);return(0,a.sendEmail)({to:e.email,subject:{27:"â° Your trial ends in 3 days",28:"Last chance: Trial ends tomorrow",29:"Final reminder: Trial ends today"}[r],html:l,text:s,tags:[{name:"email_type",value:`trial_urgency_day${r}`}]})}catch(t){return(0,o.logError)("Failed to send trial urgency email",t,{user:e.email,day:r}),null}}async function p(e){try{let t={user:{first_name:e.firstName||e.email.split("@")[0]||"User",email:e.email}},r=await (0,i.renderEmailTemplate)("trial_ended",t),o=(0,i.generatePlainText)(r);return(0,a.sendEmail)({to:e.email,subject:"Your trial has ended - Choose your plan",html:r,text:o,tags:[{name:"email_type",value:"trial_ended"}]})}catch(t){return(0,o.logError)("Failed to send trial ended email",t,{user:e.email}),null}}async function m(e){try{let t={user:{first_name:e.firstName||e.email.split("@")[0]||"User",email:e.email}},r=await (0,i.renderEmailTemplate)("paid_welcome",t),o=(0,i.generatePlainText)(r);return(0,a.sendEmail)({to:e.email,subject:"Welcome to Commercial! \uD83C\uDF89",html:r,text:o,tags:[{name:"email_type",value:"paid_welcome"}]})}catch(t){return(0,o.logError)("Failed to send paid welcome email",t,{user:e.email}),null}}async function E(e,t){try{let r=new Date().toLocaleString("en-US",{month:"long"}),o={user:{first_name:e.firstName||e.email.split("@")[0]||"User",email:e.email},monthly:{month:r},metrics:{total_reconciliations:t.totalReconciliations,accuracy:t.accuracy,time_saved:t.timeSaved,jobs_created:t.jobsCreated},recommendations:{...t.topInsight1&&{top_insight_1:t.topInsight1},...t.topInsight2&&{top_insight_2:t.topInsight2},...t.recommendation1&&{recommendation_1:t.recommendation1},...t.recommendation2&&{recommendation_2:t.recommendation2}}},n=await (0,i.renderEmailTemplate)("monthly_summary",o),l=(0,i.generatePlainText)(n);return(0,a.sendEmail)({to:e.email,subject:`${e.firstName||"You"}, your ${r} summary`,html:n,text:l,tags:[{name:"email_type",value:"monthly_summary"}]})}catch(t){return(0,o.logError)("Failed to send monthly summary email",t,{user:e.email}),null}}async function f(e){try{let t={user:{first_name:e.firstName||e.email.split("@")[0]||"User",email:e.email}},r=await (0,i.renderEmailTemplate)("low_activity",t),o=(0,i.generatePlainText)(r);return(0,a.sendEmail)({to:e.email,subject:`${e.firstName||"We"} miss you`,html:r,text:o,tags:[{name:"email_type",value:"low_activity"}]})}catch(t){return(0,o.logError)("Failed to send low activity email",t,{user:e.email}),null}}},5383:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.renderEmailTemplate=l,t.generatePlainText=function(e){let t,r=e.replace(/<style[^>]*>.*?<\/style>/gis,"").replace(/<script[^>]*>.*?<\/script>/gis,"").replace(/<[^>]+>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/\s+/g," ").trim(),a=/<a[^>]+href=["']([^"']+)["'][^>]*>(.*?)<\/a>/gi;for(;null!==(t=a.exec(e));){if(!t||!t[1]||!t[2])continue;let e=t[1],a=t[2].replace(/<[^>]+>/g,"");r=r.replace(a,`${a} (${e})`)}return r},t.getDefaultUrls=function(){let e=process.env.APP_URL||process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:"https://app.settler.dev";return{product_name:"Settler",upgrade_url:`${e}/pricing`,dashboard_url:`${e}/dashboard`,support_url:`${e}/support`,pricing_url:`${e}/pricing`,docs_url:`${e}/docs`,playground_url:`${e}/playground`,cookbooks_url:`${e}/cookbooks`,profile_setup_url:`${e}/dashboard?setup=profile`,demo_url:`${e}/playground?demo=true`,free_tier_url:`${e}/pricing#free`,free_tier_info_url:`${e}/pricing#free`,consultation_url:`${e}/support?book=consultation`,insights_url:`${e}/dashboard/insights`}};let a=r(92048),i=r(55315),o=r(43863);function n(e,t){let r=(e,t="")=>{let a={};for(let i in e)e[i]&&"object"==typeof e[i]&&!Array.isArray(e[i])?Object.assign(a,r(e[i],`${t}${i}.`)):a[`${t}${i}`]=e[i];return a},a=r(t);return e.replace(/\{\{([^}]+)\}\}/g,(e,r)=>{let i=a[r]??t[r];return null==i?((0,o.logWarn)(`Email template field not found: ${r}`),e):String(i)})}async function l(e,t){let r=function(e){let t=function(e){try{let t=(0,i.join)(process.cwd(),"emails","lifecycle",`${e}.html`);try{return(0,a.readFileSync)(t,"utf8")}catch{let t=(0,i.join)(process.cwd(),"emails",`${e}.html`);return(0,a.readFileSync)(t,"utf8")}}catch(t){throw(0,o.logError)("Failed to load email template",t,{templateName:e}),Error(`Email template not found: ${e}`)}}(e);try{let e=(0,i.join)(process.cwd(),"emails","shared","components","header.html"),r=(0,i.join)(process.cwd(),"emails","shared","components","footer.html"),o=(0,i.join)(process.cwd(),"emails","shared","components","button.html"),l=(0,a.readFileSync)(e,"utf8"),s=(0,a.readFileSync)(r,"utf8"),u=(0,a.readFileSync)(o,"utf8");t=(t=(t=t.replace(/\{\{>\s*header\s*\}\}/g,l)).replace(/\{\{>\s*footer\s*\}\}/g,s)).replace(/\{\{>\s*button\s+([^}]+)\}\}/g,(e,t)=>{let r={};return t.split(/\s+/).forEach(e=>{let[t,a]=e.split("=");t&&a&&(r[t]=a.replace(/['"]/g,""))}),n(u,r)})}catch(e){(0,o.logWarn)("Failed to load shared components, using template as-is",{error:e})}return t}(e);return n(r,t)}},67894:(e,t,r)=>{var a=Object.create?function(e,t,r,a){void 0===a&&(a=r);var i=Object.getOwnPropertyDescriptor(t,r);(!i||("get"in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,i)}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]},i=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t},o=function(){var e=function(t){return(e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t})(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var o=e(t),n=0;n<o.length;n++)"default"!==o[n]&&a(r,t,o[n]);return i(r,t),r}}();Object.defineProperty(t,"__esModule",{value:!0}),t.sendEmail=_,t.sendVerificationEmail=p,t.sendPasswordResetEmail=m,t.sendWelcomeEmail=E,t.sendNotificationEmail=f,t.sendMagicLinkEmail=g;let n=r(65851),l=r(43863),s=process.env.RESEND_API_KEY,u=process.env.RESEND_FROM_EMAIL||"noreply@settler.dev",c=process.env.RESEND_FROM_NAME||"Settler",d=null;async function _(e){if(!d)return(0,l.logWarn)("Resend client not initialized - email not sent",{to:e.to,subject:e.subject}),null;try{let t=await d.emails.send({from:e.from||`${c} <${u}>`,to:Array.isArray(e.to)?e.to:[e.to],subject:e.subject,html:e.html,text:e.text,...e.replyTo&&{reply_to:e.replyTo},tags:e.tags});return(0,l.logInfo)("Email sent successfully",{emailId:t.data?.id||"unknown",to:e.to,subject:e.subject}),{id:t.data?.id||"unknown"}}catch(t){throw(0,l.logError)("Failed to send email",t,{to:e.to,subject:e.subject}),t}}async function p(e,t,r){let a=r||e.split("@")[0];return _({to:e,subject:"Verify your Settler account",html:`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
        </head>
        <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h1 style="color: #2563eb;">Welcome to Settler, ${a}!</h1>
          <p>Thanks for signing up. Please verify your email address by clicking the button below:</p>
          <div style="text-align: center; margin: 30px 0;">
            <a href="${t}" style="background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Verify Email</a>
          </div>
          <p style="color: #666; font-size: 14px;">If the button doesn't work, copy and paste this link into your browser:</p>
          <p style="color: #666; font-size: 14px; word-break: break-all;">${t}</p>
          <p style="color: #666; font-size: 14px; margin-top: 30px;">This link will expire in 24 hours.</p>
        </body>
      </html>
    `,text:`
      Welcome to Settler, ${a}!
      
      Thanks for signing up. Please verify your email address by visiting this link:
      ${t}
      
      This link will expire in 24 hours.
    `,tags:[{name:"email_type",value:"verification"}]})}async function m(e,t,r){let a=r||e.split("@")[0];return _({to:e,subject:"Reset your Settler password",html:`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
        </head>
        <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h1 style="color: #2563eb;">Password Reset Request</h1>
          <p>Hi ${a},</p>
          <p>We received a request to reset your password. Click the button below to create a new password:</p>
          <div style="text-align: center; margin: 30px 0;">
            <a href="${t}" style="background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Reset Password</a>
          </div>
          <p style="color: #666; font-size: 14px;">If the button doesn't work, copy and paste this link into your browser:</p>
          <p style="color: #666; font-size: 14px; word-break: break-all;">${t}</p>
          <p style="color: #666; font-size: 14px; margin-top: 30px;">This link will expire in 1 hour.</p>
          <p style="color: #999; font-size: 12px; margin-top: 30px;">If you didn't request this, you can safely ignore this email.</p>
        </body>
      </html>
    `,text:`
      Password Reset Request
      
      Hi ${a},
      
      We received a request to reset your password. Visit this link to create a new password:
      ${t}
      
      This link will expire in 1 hour.
      
      If you didn't request this, you can safely ignore this email.
    `,tags:[{name:"email_type",value:"password_reset"}]})}async function E(e,t,a,i,n){if(i&&n){let{sendTrialWelcomeEmail:a}=await Promise.resolve().then(()=>o(r(70058)));return a({email:e,firstName:t||e.split("@")[0]||"User",planType:"trial"},{trialStartDate:new Date().toISOString(),trialEndDate:n,daysRemaining:Math.ceil((new Date(n).getTime()-Date.now())/864e5)})}let l=t||e.split("@")[0],s=a||"https://app.settler.dev/dashboard";return _({to:e,subject:"Welcome to Settler! \uD83C\uDF89",html:`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
        </head>
        <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h1 style="color: #2563eb;">Welcome to Settler, ${l}! ðŸŽ‰</h1>
          <p>Your account is now verified and ready to use.</p>
          <p>Get started by:</p>
          <ul>
            <li>Creating your first reconciliation job</li>
            <li>Connecting your payment adapters (Stripe, PayPal, etc.)</li>
            <li>Exploring the dashboard</li>
          </ul>
          <div style="text-align: center; margin: 30px 0;">
            <a href="${s}" style="background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Go to Dashboard</a>
          </div>
          <p style="color: #666; font-size: 14px;">Need help? Check out our <a href="https://docs.settler.dev">documentation</a> or reach out to <a href="mailto:support@settler.dev">support@settler.dev</a>.</p>
        </body>
      </html>
    `,text:`
      Welcome to Settler, ${l}! ðŸŽ‰
      
      Your account is now verified and ready to use.
      
      Get started by creating your first reconciliation job and connecting your payment adapters.
      
      Go to your dashboard: ${s}
      
      Need help? Check out our documentation or reach out to support@settler.dev.
    `,tags:[{name:"email_type",value:"welcome"}]})}async function f(e,t,r,a,i,o){let n=o||e.split("@")[0];return _({to:e,subject:t,html:`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
        </head>
        <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h1 style="color: #2563eb;">${t}</h1>
          <p>Hi ${n},</p>
          <p>${r}</p>
          ${a&&i?`
            <div style="text-align: center; margin: 30px 0;">
              <a href="${a}" style="background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">${i}</a>
            </div>
          `:""}
        </body>
      </html>
    `,text:`
      ${t}
      
      Hi ${n},
      
      ${r}
      
      ${a?`Visit: ${a}`:""}
    `,tags:[{name:"email_type",value:"notification"}]})}async function g(e,t,r){let a=r||e.split("@")[0];return _({to:e,subject:"Sign in to Settler",html:`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
        </head>
        <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h1 style="color: #2563eb;">Sign in to Settler</h1>
          <p>Hi ${a},</p>
          <p>Click the button below to sign in to your account:</p>
          <div style="text-align: center; margin: 30px 0;">
            <a href="${t}" style="background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Sign In</a>
          </div>
          <p style="color: #666; font-size: 14px;">If the button doesn't work, copy and paste this link into your browser:</p>
          <p style="color: #666; font-size: 14px; word-break: break-all;">${t}</p>
          <p style="color: #666; font-size: 14px; margin-top: 30px;">This link will expire in 15 minutes.</p>
          <p style="color: #999; font-size: 12px; margin-top: 30px;">If you didn't request this, you can safely ignore this email.</p>
        </body>
      </html>
    `,text:`
      Sign in to Settler
      
      Hi ${a},
      
      Click this link to sign in to your account:
      ${t}
      
      This link will expire in 15 minutes.
      
      If you didn't request this, you can safely ignore this email.
    `,tags:[{name:"email_type",value:"magic_link"}]})}s?d=new n.Resend(s):(0,l.logWarn)("RESEND_API_KEY not set - email sending will be disabled")},43863:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0,t.logInfo=function(e,r){u()&&t.logger.info(e,(0,i.redact)(r))},t.logError=function(e,r,a){let o=r instanceof Error?r:{message:String(r)};t.logger.error(e,{...(0,i.redact)(a),error:o.message,stack:r instanceof Error&&"stack"in o&&o.stack?String(o.stack):void 0})},t.logWarn=function(e,r){u()&&t.logger.warn(e,(0,i.redact)(r))},t.logDebug=function(e,r){u()&&t.logger.debug(e,(0,i.redact)(r))},t.logBusinessEvent=function(e,r){t.logger.info(`business_event:${e}`,{event_type:e,...(0,i.redact)(r)})},t.logPerformance=function(e,r,a){t.logger.info(`performance:${e}`,{operation:e,duration_ms:r,...(0,i.redact)(a)})};let a=function(e){return e&&e.__esModule?e:{default:e}}(r(93621)),i=r(91338),o=r(27561),n=r(11045),l=a.default.format(e=>{let t=function(){let e=o.trace.getActiveSpan();if(!e)return{};let t=e.spanContext();return{trace_id:t.traceId,span_id:t.spanId}}();return{...e,...t}})(),s=a.default.format.combine(l,a.default.format.timestamp(),a.default.format.errors({stack:!0}),a.default.format.json());function u(){return n.config.logging.samplingRate>=1||Math.random()<n.config.logging.samplingRate}t.logger=a.default.createLogger({level:n.config.logging.level,format:s,defaultMeta:{service:"settler-api",environment:n.config.nodeEnv},transports:[new a.default.transports.Console({format:a.default.format.combine(a.default.format.colorize(),a.default.format.printf(e=>{let{timestamp:t,level:r,message:a,trace_id:o,span_id:n,tenant_id:l,...s}=e,u=Object.keys(s).length?JSON.stringify((0,i.redact)(s)):"",c=o&&"string"==typeof o?`[trace_id=${o.substring(0,16)}]`:"",d=n&&"string"==typeof n?`[span_id=${n.substring(0,16)}]`:"",_=l?`[tenant_id=${l}]`:"";return`${t} [${r}]${c}${d}${_}: ${a} ${u}`}))})]})},91338:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.redact=function e(t,a=[]){if(null==t||"object"!=typeof t)return t;if(Array.isArray(t))return t.map(t=>e(t,a));let i=[...r,...a],o={};for(let[r,n]of Object.entries(t)){let t=r.toLowerCase();i.some(e=>t.includes(e.toLowerCase()))?o[r]="[REDACTED]":"object"==typeof n&&null!==n?o[r]=e(n,a):o[r]=n}return o};let r=["apiKey","api_key","apiKeyHash","secret","password","token","card_number","cvv","ssn","email","phone","credit_card","passwordHash","keyHash","secret","webhookSecret"]}};