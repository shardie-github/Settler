"use strict";(()=>{var e={};e.id=7403,e.ids=[7403],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},68543:(e,a,t)=>{t.r(a),t.d(a,{originalPathname:()=>E,patchFetch:()=>g,requestAsyncStorage:()=>u,routeModule:()=>_,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var r={};t.r(r),t.d(r,{GET:()=>m});var i=t(63036),s=t(5736),n=t(15262),l=t(60942),o=t(82638);!function(){var e=Error("Cannot find module '@settler/api/lib/email-lifecycle'");throw e.code="MODULE_NOT_FOUND",e}();let p=(e,a)=>{console.log(`[INFO] ${e}`,a||"")},c=(e,a,t)=>{console.error(`[ERROR] ${e}`,{error:a?.message,...t})},d=process.env.CRON_SECRET;async function m(e){try{let a=e.headers.get("authorization");if(d&&a!==`Bearer ${d}`)return l.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,o.i)(),r={processed:0,errors:0,emails:[]},i=await t.rpc("get_trial_users_for_email",{p_days_remaining:7});if(i.data&&Array.isArray(i.data))for(let e of i.data)try{let a={trialStartDate:e.trial_start_date,trialEndDate:e.trial_end_date,daysRemaining:e.days_remaining},i={email:e.email,firstName:e.name?.split(" ")[0],industry:e.industry,companyName:e.company_name,planType:e.plan_type};await Object(function(){var e=Error("Cannot find module '@settler/api/lib/email-lifecycle'");throw e.code="MODULE_NOT_FOUND",e}())(i,a),await t.rpc("update_email_sent",{p_user_id:e.id,p_email_type:"trial_day7"}),r.processed++,r.emails.push(e.email)}catch(a){c("Failed to send Day 7 email",a,{user:e.email}),r.errors++}let s=await t.rpc("get_trial_users_for_email",{p_days_remaining:14});if(s.data&&Array.isArray(s.data))for(let e of s.data)try{let a={trialStartDate:e.trial_start_date,trialEndDate:e.trial_end_date,daysRemaining:e.days_remaining},i={email:e.email,firstName:e.name?.split(" ")[0],industry:e.industry,companyName:e.company_name,planType:e.plan_type};await Object(function(){var e=Error("Cannot find module '@settler/api/lib/email-lifecycle'");throw e.code="MODULE_NOT_FOUND",e}())(i,a,{companyName:"Example Company",caseStudyUrl:`${process.env.APP_URL||"https://app.settler.dev"}/case-studies/example`}),await t.rpc("update_email_sent",{p_user_id:e.id,p_email_type:"trial_day14"}),r.processed++,r.emails.push(e.email)}catch(a){c("Failed to send Day 14 email",a,{user:e.email}),r.errors++}let n=await t.rpc("get_trial_users_for_email",{p_days_remaining:9});if(n.data&&Array.isArray(n.data))for(let e of n.data)try{let a={trialStartDate:e.trial_start_date,trialEndDate:e.trial_end_date,daysRemaining:e.days_remaining},i={email:e.email,firstName:e.name?.split(" ")[0],industry:e.industry,companyName:e.company_name,planType:e.plan_type};await Object(function(){var e=Error("Cannot find module '@settler/api/lib/email-lifecycle'");throw e.code="MODULE_NOT_FOUND",e}())(i,a),await t.rpc("update_email_sent",{p_user_id:e.id,p_email_type:"trial_day21"}),r.processed++,r.emails.push(e.email)}catch(a){c("Failed to send Day 21 email",a,{user:e.email}),r.errors++}for(let e of[27,28,29]){let a=27===e?3:28===e?2:1,i=await t.rpc("get_trial_users_for_email",{p_days_remaining:a});if(i.data&&Array.isArray(i.data))for(let a of i.data)try{let i={trialStartDate:a.trial_start_date,trialEndDate:a.trial_end_date,daysRemaining:a.days_remaining},s={email:a.email,firstName:a.name?.split(" ")[0],industry:a.industry,companyName:a.company_name,planType:a.plan_type};await Object(function(){var e=Error("Cannot find module '@settler/api/lib/email-lifecycle'");throw e.code="MODULE_NOT_FOUND",e}())(s,i,e),await t.rpc("update_email_sent",{p_user_id:a.id,p_email_type:`trial_day${e}`}),r.processed++,r.emails.push(a.email)}catch(t){c(`Failed to send Day ${e} email`,t,{user:a.email}),r.errors++}}let m=await t.rpc("get_trial_users_for_email",{p_days_remaining:0});if(m.data&&Array.isArray(m.data))for(let e of m.data)try{let a={email:e.email,firstName:e.name?.split(" ")[0],industry:e.industry,companyName:e.company_name,planType:e.plan_type};await Object(function(){var e=Error("Cannot find module '@settler/api/lib/email-lifecycle'");throw e.code="MODULE_NOT_FOUND",e}())(a),await t.from("profiles").update({plan_type:"free"}).eq("id",e.id).eq("plan_type","trial"),await t.rpc("update_email_sent",{p_user_id:e.id,p_email_type:"trial_ended"}),r.processed++,r.emails.push(e.email)}catch(a){c("Failed to send trial ended email",a,{user:e.email}),r.errors++}return p("Email lifecycle cron job completed",{processed:r.processed,errors:r.errors,emailCount:r.emails.length}),l.NextResponse.json({success:!0,processed:r.processed,errors:r.errors,emails:r.emails})}catch(e){return c("Email lifecycle cron job failed",e),l.NextResponse.json({error:"Internal server error",message:e.message},{status:500})}}let _=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/cron/email-lifecycle/route",pathname:"/api/cron/email-lifecycle",filename:"route",bundlePath:"app/api/cron/email-lifecycle/route"},resolvedPagePath:"/workspace/packages/web/src/app/api/cron/email-lifecycle/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:u,staticGenerationAsyncStorage:y,serverHooks:f}=_,E="/api/cron/email-lifecycle/route";function g(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},82638:(e,a,t)=>{t.d(a,{e:()=>s,i:()=>n});var r=t(66603),i=t(9362);async function s(){let e=await (0,i.cookies)(),a=process.env.SUPABASE_URL||process.env.NEXT_PUBLIC_SUPABASE_URL||"",t=process.env.SUPABASE_ANON_KEY||process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"";return a&&t||console.warn("Supabase environment variables not set - some features may not work"),(0,r.createServerClient)(a,t,{cookies:{get:a=>e.get(a)?.value,set(a,t,r){try{e.set({name:a,value:t,...r})}catch(e){}},remove(a,t){try{e.set({name:a,value:"",...t})}catch(e){}}}})}async function n(){let e=process.env.SUPABASE_URL||process.env.NEXT_PUBLIC_SUPABASE_URL||"",a=process.env.SUPABASE_SERVICE_ROLE_KEY||"";e&&a||console.warn("Supabase admin environment variables not set - admin features may not work");let{createClient:r}=await Promise.resolve().then(t.bind(t,65365));return r(e,a,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),r=a.X(0,[4522,1920,1746],()=>t(68543));module.exports=r})();