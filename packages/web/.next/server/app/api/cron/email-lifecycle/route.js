"use strict";(()=>{var e={};e.id=7403,e.ids=[7403],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61212:e=>{e.exports=require("async_hooks")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},68543:(e,a,r)=>{r.r(a),r.d(a,{originalPathname:()=>x,patchFetch:()=>E,requestAsyncStorage:()=>y,routeModule:()=>u,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var t={};r.r(t),r.d(t,{GET:()=>_});var i=r(63036),s=r(5736),n=r(15262),l=r(60942),o=r(82638),p=r(70058);let d=(e,a)=>{console.log(`[INFO] ${e}`,a||"")},m=(e,a,r)=>{console.error(`[ERROR] ${e}`,{error:a?.message,...r})},c=process.env.CRON_SECRET;async function _(e){try{let a=e.headers.get("authorization");if(c&&a!==`Bearer ${c}`)return l.NextResponse.json({error:"Unauthorized"},{status:401});let r=await (0,o.i)(),t={processed:0,errors:0,emails:[]},i=await r.rpc("get_trial_users_for_email",{p_days_remaining:7});if(i.data&&Array.isArray(i.data))for(let e of i.data)try{let a={trialStartDate:e.trial_start_date,trialEndDate:e.trial_end_date,daysRemaining:e.days_remaining},i={email:e.email,firstName:e.name?.split(" ")[0],industry:e.industry,companyName:e.company_name,planType:e.plan_type};await (0,p.sendTrialGatedFeaturesEmail)(i,a),await r.rpc("update_email_sent",{p_user_id:e.id,p_email_type:"trial_day7"}),t.processed++,t.emails.push(e.email)}catch(a){m("Failed to send Day 7 email",a,{user:e.email}),t.errors++}let s=await r.rpc("get_trial_users_for_email",{p_days_remaining:14});if(s.data&&Array.isArray(s.data))for(let e of s.data)try{let a={trialStartDate:e.trial_start_date,trialEndDate:e.trial_end_date,daysRemaining:e.days_remaining},i={email:e.email,firstName:e.name?.split(" ")[0],industry:e.industry,companyName:e.company_name,planType:e.plan_type};await (0,p.sendTrialCaseStudyEmail)(i,a,{companyName:"Example Company",caseStudyUrl:`${process.env.APP_URL||"https://app.settler.dev"}/case-studies/example`}),await r.rpc("update_email_sent",{p_user_id:e.id,p_email_type:"trial_day14"}),t.processed++,t.emails.push(e.email)}catch(a){m("Failed to send Day 14 email",a,{user:e.email}),t.errors++}let n=await r.rpc("get_trial_users_for_email",{p_days_remaining:9});if(n.data&&Array.isArray(n.data))for(let e of n.data)try{let a={trialStartDate:e.trial_start_date,trialEndDate:e.trial_end_date,daysRemaining:e.days_remaining},i={email:e.email,firstName:e.name?.split(" ")[0],industry:e.industry,companyName:e.company_name,planType:e.plan_type};await (0,p.sendTrialComparisonEmail)(i,a),await r.rpc("update_email_sent",{p_user_id:e.id,p_email_type:"trial_day21"}),t.processed++,t.emails.push(e.email)}catch(a){m("Failed to send Day 21 email",a,{user:e.email}),t.errors++}for(let e of[27,28,29]){let a=27===e?3:28===e?2:1,i=await r.rpc("get_trial_users_for_email",{p_days_remaining:a});if(i.data&&Array.isArray(i.data))for(let a of i.data)try{let i={trialStartDate:a.trial_start_date,trialEndDate:a.trial_end_date,daysRemaining:a.days_remaining},s={email:a.email,firstName:a.name?.split(" ")[0],industry:a.industry,companyName:a.company_name,planType:a.plan_type};await (0,p.sendTrialUrgencyEmail)(s,i,e),await r.rpc("update_email_sent",{p_user_id:a.id,p_email_type:`trial_day${e}`}),t.processed++,t.emails.push(a.email)}catch(r){m(`Failed to send Day ${e} email`,r,{user:a.email}),t.errors++}}let _=await r.rpc("get_trial_users_for_email",{p_days_remaining:0});if(_.data&&Array.isArray(_.data))for(let e of _.data)try{let a={email:e.email,firstName:e.name?.split(" ")[0],industry:e.industry,companyName:e.company_name,planType:e.plan_type};await (0,p.sendTrialEndedEmail)(a),await r.from("profiles").update({plan_type:"free"}).eq("id",e.id).eq("plan_type","trial"),await r.rpc("update_email_sent",{p_user_id:e.id,p_email_type:"trial_ended"}),t.processed++,t.emails.push(e.email)}catch(a){m("Failed to send trial ended email",a,{user:e.email}),t.errors++}return d("Email lifecycle cron job completed",{processed:t.processed,errors:t.errors,emailCount:t.emails.length}),l.NextResponse.json({success:!0,processed:t.processed,errors:t.errors,emails:t.emails})}catch(e){return m("Email lifecycle cron job failed",e),l.NextResponse.json({error:"Internal server error",message:e.message},{status:500})}}let u=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/cron/email-lifecycle/route",pathname:"/api/cron/email-lifecycle",filename:"route",bundlePath:"app/api/cron/email-lifecycle/route"},resolvedPagePath:"/workspace/packages/web/src/app/api/cron/email-lifecycle/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:y,staticGenerationAsyncStorage:f,serverHooks:g}=u,x="/api/cron/email-lifecycle/route";function E(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},42378:(e,a,r)=>{e.exports=r(93282).vendored["react-rsc"].ReactDOM},82638:(e,a,r)=>{r.d(a,{e:()=>s,i:()=>n});var t=r(66603),i=r(9362);async function s(){let e=await (0,i.cookies)(),a=process.env.SUPABASE_URL||process.env.NEXT_PUBLIC_SUPABASE_URL||"",r=process.env.SUPABASE_ANON_KEY||process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"";return a&&r||console.warn("Supabase environment variables not set - some features may not work"),(0,t.createServerClient)(a,r,{cookies:{get:a=>e.get(a)?.value,set(a,r,t){try{e.set({name:a,value:r,...t})}catch(e){}},remove(a,r){try{e.set({name:a,value:"",...r})}catch(e){}}}})}async function n(){let e=process.env.SUPABASE_URL||process.env.NEXT_PUBLIC_SUPABASE_URL||"",a=process.env.SUPABASE_SERVICE_ROLE_KEY||"";e&&a||console.warn("Supabase admin environment variables not set - admin features may not work");let{createClient:t}=await Promise.resolve().then(r.bind(r,65365));return t(e,a,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var a=require("../../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),t=a.X(0,[4522,1920,1746,7472,221],()=>r(68543));module.exports=t})();