name: Auto-Migrate on Merge to Main

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  check-and-migrate:
    name: Check for Migrations and Run
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history to compare
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci
      - name: Check for migration files
        id: check-migrations
        run: |
          echo "üîç Checking for new migration files..."
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # Check if any migration files were added or modified
          MIGRATIONS=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep -E "packages/api/src/db/migrations/.*\.sql$" || true)
          
          if [ -z "$MIGRATIONS" ]; then
            echo "has_migrations=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No new migration files detected"
          else
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "migrations<<EOF" >> $GITHUB_OUTPUT
            echo "$MIGRATIONS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "‚úÖ Found migration files:"
            echo "$MIGRATIONS"
          fi
      - name: Run migrations (if needed)
        if: steps.check-migrations.outputs.has_migrations == 'true'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: production
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        run: |
          echo "üîÑ Running database migrations..."
          echo "Migration files to apply:"
          echo "${{ steps.check-migrations.outputs.migrations }}"
          
          cd packages/api
          npm run migrate:prod
          
          echo "‚úÖ Migrations completed successfully"
      - name: Create migration summary
        if: steps.check-migrations.outputs.has_migrations == 'true'
        run: |
          echo "## üóÑÔ∏è Database Migrations Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following migration files were applied:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.check-migrations.outputs.migrations }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Migrations completed successfully" >> $GITHUB_STEP_SUMMARY
      - name: Skip migrations (no changes)
        if: steps.check-migrations.outputs.has_migrations == 'false'
        run: |
          echo "‚ÑπÔ∏è  No migration files detected in this PR"
          echo "Skipping migration step"
