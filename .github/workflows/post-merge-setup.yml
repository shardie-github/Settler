name: Post-Merge Setup & Migrations

on:
  push:
    branches:
      - main
    paths:
      - 'packages/api/src/db/migrations/**'
      - 'packages/api/**'
      - '.github/workflows/post-merge-setup.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  validate-environment:
    name: Validate Environment Schema
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Validate environment variable schema
        run: |
          echo "ðŸ” Validating environment variable schema..."
          npx --yes tsx --check config/env.schema.ts
          echo "âœ… Environment schema is valid"
      - name: Check environment variable completeness
        run: |
          echo "ðŸ” Checking environment variable completeness..."
          npx --yes tsx scripts/check-env.ts production --json > env-validation.json || true
          if [ -f env-validation.json ]; then
            echo "Environment validation completed"
            cat env-validation.json | jq '.summary' || echo "Could not parse validation results"
          else
            echo "âš ï¸  Environment validation skipped (no real env vars in CI)"
          fi

  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [validate-environment]
    if: contains(github.event.head_commit.message, '[migrate]') || contains(github.event.head_commit.message, '[migration]') || github.event_name == 'workflow_dispatch'
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: settler_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/settler_test
      NODE_ENV: production
      JWT_SECRET: test-secret-min-32-chars-long-for-testing-ci
      ENCRYPTION_KEY: test-encryption-key-32-chars-long!!
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "âœ… PostgreSQL is ready"
      - name: Run database migrations
        run: |
          echo "ðŸ”„ Running database migrations..."
          cd packages/api
          npm run migrate
          echo "âœ… Migrations completed successfully"
      - name: Verify migrations
        run: |
          echo "ðŸ” Verifying migration state..."
          cd packages/api
          # Check that refresh_tokens table exists (from migration 009)
          PGPASSWORD=postgres psql -h localhost -U postgres -d settler_test -c "\d refresh_tokens" || echo "âš ï¸  refresh_tokens table not found (may not be needed)"
          echo "âœ… Migration verification complete"

  startup-validation:
    name: Startup Validation Test
    runs-on: ubuntu-latest
    needs: [validate-environment]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: settler_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/settler_test
      REDIS_URL: redis://localhost:6379
      NODE_ENV: production
      JWT_SECRET: test-secret-min-32-chars-long-for-testing-ci
      ENCRYPTION_KEY: test-encryption-key-32-chars-long!!
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Build application
        run: npm run build
      - name: Run startup validation
        run: |
          echo "ðŸ” Running startup validation..."
          cd packages/api
          # Start server in background and capture startup validation output
          timeout 30 npm start > startup.log 2>&1 &
          SERVER_PID=$!
          sleep 5
          # Check if server started successfully
          if ps -p $SERVER_PID > /dev/null; then
            echo "âœ… Server started successfully"
            # Check startup log for validation results
            if grep -q "Startup validation" startup.log; then
              echo "âœ… Startup validation detected in logs"
            fi
            # Kill server
            kill $SERVER_PID || true
          else
            echo "âš ï¸  Server did not start (checking logs)"
            cat startup.log || true
            exit 1
          fi

  verify-deployment-readiness:
    name: Verify Deployment Readiness
    runs-on: ubuntu-latest
    needs: [validate-environment, startup-validation]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Check build artifacts
        run: |
          echo "ðŸ” Verifying build artifacts..."
          npm run build
          test -d packages/api/dist || (echo "âŒ API dist directory not found" && exit 1)
          test -d packages/sdk/dist || (echo "âŒ SDK dist directory not found" && exit 1)
          echo "âœ… All build artifacts present"
      - name: Verify type safety
        run: |
          echo "ðŸ” Verifying type safety..."
          npm run typecheck
          echo "âœ… Type checking passed"
      - name: Verify linting
        run: |
          echo "ðŸ” Verifying code quality..."
          npm run lint
          echo "âœ… Linting passed"
      - name: Check for secrets
        run: |
          echo "ðŸ” Checking for accidentally committed secrets..."
          # Check for common secret patterns
          if grep -r "sk_live_" packages/ --exclude-dir=node_modules --exclude-dir=dist 2>/dev/null; then
            echo "âŒ Potential live secret found!"
            exit 1
          fi
          if grep -r "rk_live_" packages/ --exclude-dir=node_modules --exclude-dir=dist 2>/dev/null; then
            echo "âŒ Potential live API key found!"
            exit 1
          fi
          echo "âœ… No secrets detected in code"
      - name: Verify documentation
        run: |
          echo "ðŸ” Verifying documentation completeness..."
          test -f README.md || (echo "âŒ README.md missing" && exit 1)
          test -f ARCHITECTURE.md || (echo "âŒ ARCHITECTURE.md missing" && exit 1)
          test -f docs/CONTRIBUTING.md || (echo "âŒ CONTRIBUTING.md missing" && exit 1)
          echo "âœ… All required documentation present"

  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [validate-environment, startup-validation, verify-deployment-readiness]
    if: always()
    steps:
      - name: Post-merge summary
        run: |
          echo "## ðŸŽ‰ Post-Merge Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Actions" >> $GITHUB_STEP_SUMMARY
          echo "- Environment validation" >> $GITHUB_STEP_SUMMARY
          echo "- Startup validation" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment readiness check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Database migrations will run automatically in production" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor deployment logs for any issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify health endpoints after deployment" >> $GITHUB_STEP_SUMMARY
