name: Post-Merge Validation & Setup

on:
  push:
    branches:
      - main

jobs:
  comprehensive-validation:
    name: Comprehensive Post-Merge Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      
      - name: Validate environment schema
        run: |
          echo "ðŸ” Validating environment variable schema..."
          npx --yes tsx --check config/env.schema.ts
          echo "âœ… Environment schema valid"
      
      - name: Type check
        run: |
          echo "ðŸ” Running TypeScript type check..."
          npm run typecheck
          echo "âœ… Type check passed"
      
      - name: Lint check
        run: |
          echo "ðŸ” Running ESLint..."
          npm run lint
          echo "âœ… Lint check passed"
      
      - name: Format check
        run: |
          echo "ðŸ” Checking code formatting..."
          npm run format:check
          echo "âœ… Format check passed"
      
      - name: Build all packages
        run: |
          echo "ðŸ” Building all packages..."
          npm run build
          echo "âœ… Build completed"
      
      - name: Verify build artifacts
        run: |
          echo "ðŸ” Verifying build artifacts..."
          test -d packages/api/dist && echo "âœ… API dist exists" || (echo "âŒ API dist missing" && exit 1)
          test -d packages/sdk/dist && echo "âœ… SDK dist exists" || (echo "âŒ SDK dist missing" && exit 1)
          echo "âœ… All build artifacts verified"
      
      - name: Check for secrets in code
        run: |
          echo "ðŸ” Scanning for accidentally committed secrets..."
          # Check for common secret patterns
          if grep -rE "(sk_live_|rk_live_|password.*=.*['\"][^'\"]{8,})" packages/ --exclude-dir=node_modules --exclude-dir=dist 2>/dev/null | grep -v "test" | grep -v "example"; then
            echo "âŒ Potential secrets found in code!"
            exit 1
          fi
          echo "âœ… No secrets detected"
      
      - name: Verify documentation
        run: |
          echo "ðŸ” Verifying documentation..."
          REQUIRED_DOCS=(
            "README.md"
            "ARCHITECTURE.md"
            "docs/CONTRIBUTING.md"
            "docs/API.md"
          )
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ… $doc exists"
            else
              echo "âŒ $doc missing"
              exit 1
            fi
          done
          echo "âœ… All required documentation present"
      
      - name: Check migration files
        run: |
          echo "ðŸ” Checking migration files..."
          if [ -d "packages/api/src/db/migrations" ]; then
            MIGRATION_COUNT=$(find packages/api/src/db/migrations -name "*.sql" | wc -l)
            echo "âœ… Found $MIGRATION_COUNT migration files"
          else
            echo "âš ï¸  Migrations directory not found"
          fi

  run-migrations-staging:
    name: Run Migrations on Staging
    runs-on: ubuntu-latest
    needs: [comprehensive-validation]
    environment: staging # Requires staging environment secrets
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Build application
        run: npm run build
      - name: Run staging migrations
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          NODE_ENV: staging
          JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.STAGING_ENCRYPTION_KEY }}
        run: |
          echo "ðŸ”„ Running staging database migrations..."
          cd packages/api
          npm run migrate:prod
          echo "âœ… Staging migrations completed"
      - name: Verify staging health
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
        run: |
          echo "ðŸ” Verifying staging health..."
          sleep 5
          curl -f ${STAGING_URL}/health || echo "âš ï¸  Health check failed"
          echo "âœ… Staging verification complete"

  run-migrations-production:
    name: Run Migrations on Production
    runs-on: ubuntu-latest
    needs: [comprehensive-validation, run-migrations-staging]
    environment: production # Requires production environment secrets and approval
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Build application
        run: npm run build
      - name: Run production migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: production
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        run: |
          echo "ðŸ”„ Running production database migrations..."
          echo "âš ï¸  PRODUCTION MIGRATION - This will modify the production database"
          cd packages/api
          npm run migrate:prod
          echo "âœ… Production migrations completed"
      - name: Verify production health
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          echo "ðŸ” Verifying production health..."
          sleep 10 # Wait for deployment
          curl -f ${PRODUCTION_URL}/health || echo "âš ï¸  Health check failed"
          curl -f ${PRODUCTION_URL}/health/detailed || echo "âš ï¸  Detailed health check failed"
          echo "âœ… Production health verified"

  post-deployment-verification:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: [run-migrations-production]
    if: success()
    steps:
      - uses: actions/checkout@v4
      - name: Verify all endpoints
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          echo "ðŸ” Running post-deployment verification..."
          
          # Health check
          echo "Checking /health endpoint..."
          curl -f ${PRODUCTION_URL}/health && echo "âœ… Health endpoint OK" || echo "âŒ Health endpoint failed"
          
          # Detailed health check
          echo "Checking /health/detailed endpoint..."
          curl -f ${PRODUCTION_URL}/health/detailed && echo "âœ… Detailed health endpoint OK" || echo "âŒ Detailed health endpoint failed"
          
          # API docs
          echo "Checking /api/v1/openapi.json..."
          curl -f ${PRODUCTION_URL}/api/v1/openapi.json && echo "âœ… OpenAPI endpoint OK" || echo "âŒ OpenAPI endpoint failed"
          
          echo "âœ… Post-deployment verification complete"
      
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Actions" >> $GITHUB_STEP_SUMMARY
          echo "- Environment validation" >> $GITHUB_STEP_SUMMARY
          echo "- Type checking" >> $GITHUB_STEP_SUMMARY
          echo "- Linting" >> $GITHUB_STEP_SUMMARY
          echo "- Build verification" >> $GITHUB_STEP_SUMMARY
          echo "- Database migrations (staging â†’ production)" >> $GITHUB_STEP_SUMMARY
          echo "- Health checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Status" >> $GITHUB_STEP_SUMMARY
          echo "All systems operational âœ…" >> $GITHUB_STEP_SUMMARY
